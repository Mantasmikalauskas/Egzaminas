
import Stripe from 'stripe'; const STRIPE_KEY = process.env.STRIPE_SECRET_KEY; let stripe = null; if(STRIPE_KEY && STRIPE_KEY.length>10) stripe = new Stripe(STRIPE_KEY,{apiVersion:'2022-11-15'}); export const checkout=async(req,res,next)=>{ try{ if(!stripe) return res.status(400).json({message:'Stripe not configured. Set STRIPE_SECRET_KEY in .env'}); const {items,success_url,cancel_url}=req.body; const line_items=(items||[]).map(i=>({price_data:{currency:i.currency||'eur',product_data:{name:i.name},unit_amount:Math.round((i.amount||0)*100)},quantity:i.quantity||1})); const session=await stripe.checkout.sessions.create({payment_method_types:['card'],line_items,mode:'payment',success_url:success_url||`${process.env.FRONTEND_URL||'http://localhost:3000'}/?paid=1`,cancel_url:cancel_url||process.env.FRONTEND_URL||'http://localhost:3000'}); res.json({url:session.url}); }catch(err){ next(err);} };
